name: "Run sqllogictests"

on:
  schedule:
    - cron: '5 8 * * *'
  workflow_dispatch:
    inputs:
      ref:
        description: 'super repo branch name, tag, or commit SHA to test'
        required: true
        default: 'main'
        type: string
      fail-fast:
        description: 'Stop all tests if one fails'
        required: false
        default: false
        type: boolean
      format:
        description: 'Format to test with'
        required: true
        default: 'bsup'
        type: string

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      ref: ${{ steps.set-ref.outputs.ref }}
      fail-fast: ${{ steps.set-fail-fast.outputs.fail-fast }}
    steps:
      - id: set-ref
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=main" >> $GITHUB_OUTPUT
          fi
      - id: set-fail-fast
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "fail-fast=${{ github.event.inputs.fail-fast }}" >> $GITHUB_OUTPUT
          else
            echo "fail-fast=false" >> $GITHUB_OUTPUT
          fi

  test-sqllogic:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: ${{ needs.setup.outputs.fail-fast == 'true' }}
      matrix:
        test:
          - name: sqlite-select
            pattern: TestSPQ/ztests/sqlite/select[1-5]
          - name: sqlite-random-aggregates
            pattern: TestSPQ/ztests/sqlite/random/aggregates
          - name: sqlite-random-expr
            pattern: TestSPQ/ztests/sqlite/random/expr
          - name: sqlite-random-groupby
            pattern: TestSPQ/ztests/sqlite/random/groupby
          - name: sqlite-random-select
            pattern: TestSPQ/ztests/sqlite/random/select
    name: test-${{ matrix.test.name }}
    steps:
      - name: Remove unneeded tools to free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/hostedtoolcache/node
          sudo rm -rf /opt/hostedtoolcache/Python
          sudo rm -rf /opt/hostedtoolcache/PyPy
          sudo rm -rf /opt/hostedtoolcache/Ruby
          sudo rm -rf /opt/hostedtoolcache/CodeQL
      - name: Checkout super
        run: |
          git clone https://github.com/brimdata/super.git super
          cd super
          git checkout ${{ needs.setup.outputs.ref }}
      - name: Checkout sqllogic-ztests
        uses: actions/checkout@v5
        with:
          path: sqllogic-ztests
      - uses: actions/setup-go@v5
        with:
          go-version-file: super/go.mod
          cache-dependency-path: |
            super/go.sum
            sqllogic-ztests/go.sum
      - run: |
          patch -d super -p1 < sqllogic-ztests/super.patch
          make -C super build
      - name: Run ${{ matrix.test.name }} tests
        run: |
          for file in $(find sqllogic-ztests -name \*.parquet); do
            super/dist/super -f ${{ github.event.inputs.format }} -o "$(dirname $file)/$(basename -s .parquet $file).${{ github.event.inputs.format }}" "$file"
            ln -sf "$(basename -s .parquet $file).${{ github.event.inputs.format }}" "$(dirname $file)/$(basename -s .parquet $file)"
            rm "$file"
          done
          find sqllogic-ztests -name \*.parquet
          find sqllogic-ztests -name \*.${{ github.event.inputs.format }}
          cd sqllogic-ztests
          ZTEST_PATH="$(pwd)/../super/dist" go test . -timeout 6h -count=1 -run ${{ matrix.test.pattern }}

  summary:
    needs: test-sqllogic
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Test Results Summary"
          echo "===================="
          results='${{ needs.test-sqllogic.result }}'
          if [ "$results" != "success" ]; then
            echo "❌ Some tests failed"
            echo "Check individual job results above for details"
            exit 1
          else
            echo "✅ All test sets passed!"
          fi
